{% extends "templates/web.html" %}

{% block page_content %}
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="w-64 bg-red-600 text-white flex flex-col">
        <div class="p-4 flex items-center">
            <div class="w-8 h-8 bg-white flex items-center justify-center text-red-600 mr-2">
                <span class="font-bold">Logo</span>
            </div>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-6">
            <a href="#" class="flex items-center px-2 py-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 16a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" />
                </svg>
                Dashboard
            </a>

            <a href="#" class="flex items-center px-2 py-2 bg-red-700 rounded-md text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                </svg>
                Product Management
            </a>

            <a href="./order_management.html" class="flex items-center px-2 py-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                    <path fill-rule="evenodd"
                        d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"
                        clip-rule="evenodd" />
                </svg>
                Order Management
            </a>

            <a href="#" class="flex items-center px-2 py-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                        clip-rule="evenodd" />
                </svg>
                Customer Management
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col bg-gray-100 overflow-hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="flex justify-between items-center px-6 h-16">
                <div class="flex items-center">
                    <h2 class="text-lg font-medium">Product</h2>
                </div>

                <div class="flex items-center">
                    <div class="dropdown mr-4">
                        <button class="bg-orange-100 text-orange-800 px-3 py-1 rounded-md flex items-center text-sm">
                            Book Shop
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div class="mr-4 relative">
                        <span class="absolute top-0 right-0 h-2 w-2 bg-red-600 rounded-full"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
                        </svg>
                    </div>

                    <div>
                        <img class="h-8 w-8 rounded-full" src="https://ui-avatars.com/api/?name=User&background=random"
                            alt="User avatar">
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-1 overflow-auto px-6 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="w-64 relative">
                    <input type="text" placeholder="Search order..."
                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>

                <div class="flex space-x-2">
                    <button class="flex items-center px-3 py-2 bg-white border border-gray-300 rounded-md text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                        Export
                    </button>
                    <button class="flex items-center px-3 py-2 bg-red-600 text-white rounded-md text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                clip-rule="evenodd" />
                        </svg>
                        Add Product
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex space-x-2">
                    <button class="px-4 py-1 rounded-md bg-blue-50 text-blue-600">All Product</button>
                    <button class="px-4 py-1 rounded-md text-gray-700">Published</button>
                    <button class="px-4 py-1 rounded-md text-gray-700">Low Stock</button>
                    <button class="px-4 py-1 rounded-md text-gray-700">Draft</button>
                </div>
            </div>

            <!-- Product Table -->
            <div class="bg-white rounded-md shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="w-8 px-6 py-3 text-left">
                                    <input type="checkbox" class="h-4 w-4">
                                </th>
                                <th
                                    class="w-64 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center">
                                        Product
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Category</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center">
                                        Quantity
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center">
                                        Price
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center">
                                        Status
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="flex items-center">
                                        Added
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Action</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Product items will be loaded dynamically here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="text-sm text-gray-500">
                        Showing 1-10 from 100
                    </div>
                    <div class="flex space-x-1">
                        <button class="h-8 w-8 bg-red-600 text-white rounded-md flex items-center justify-center">
                            <span>&lt;</span>
                        </button>
                        <button class="h-8 w-8 bg-red-600 text-white rounded-md flex items-center justify-center">
                            1
                        </button>
                        <button
                            class="h-8 w-8 bg-white text-gray-700 rounded-md border flex items-center justify-center">
                            2
                        </button>
                        <button
                            class="h-8 w-8 bg-white text-gray-700 rounded-md border flex items-center justify-center">
                            3
                        </button>
                        <button
                            class="h-8 w-8 bg-white text-gray-700 rounded-md border flex items-center justify-center">
                            4
                        </button>
                        <button
                            class="h-8 w-8 bg-white text-gray-700 rounded-md border flex items-center justify-center">
                            5
                        </button>
                        <button
                            class="h-8 w-8 bg-white text-gray-700 rounded-md border flex items-center justify-center">
                            ...
                        </button>
                        <button
                            class="h-8 w-8 bg-white text-gray-700 rounded-md border flex items-center justify-center">
                            &gt;
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Form thêm/sửa sách - Modal -->
<div id="book-form-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

        <!-- Center modal -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full border border-gray-200">
            <!-- Modal header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-4">
                <h3 class="text-lg leading-6 font-semibold text-white flex items-center" id="form-modal-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd"
                            d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"
                            clip-rule="evenodd" />
                    </svg>
                    <span id="modal-title-text">Add New Book</span>
                </h3>
            </div>

            <!-- Modal body -->
            <div class="bg-white px-6 py-5">
                <form id="book-form" class="space-y-5">
                    <input type="hidden" id="book_id" name="book_id" value="">

                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label for="id" class="block text-sm font-medium text-gray-700 mb-1">ID/SKU</label>
                            <input type="text" id="id" name="id" required
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors">
                        </div>
                        <div>
                            <label for="book_name" class="block text-sm font-medium text-gray-700 mb-1">Book
                                Name</label>
                            <input type="text" id="book_name" name="book_name" required
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label for="category_id"
                                class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="category_id" name="category_id"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input type="number" id="price" name="price" min="0" step="0.01"
                                    class="block w-full pl-7 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                            <input type="number" id="quantity" name="quantity" min="0" step="1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="status" name="status"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition-colors">
                                <option value="Draft">Draft</option>
                                <option value="Published">Published</option>
                                <option value="Archived">Archived</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div>
                            <label for="thumbnail" class="block text-sm font-medium text-gray-700 mb-1">Image</label>
                            <div class="mt-1 flex items-center">
                                <div class="w-full flex">
                                    <span class="h-10 w-10 rounded-md overflow-hidden bg-gray-100 mr-3">
                                        <img id="thumbnail-preview" src="/assets/book_shop/images/default-book.svg"
                                            alt="Book thumbnail" class="h-10 w-10 object-cover">
                                    </span>
                                    <input type="file" id="thumbnail" name="thumbnail" accept="image/*"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors">
                                </div>
                            </div>
                        </div>

                    </div>
                    <div>
                        <label for="description"
                            class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <div id="description-editor" class="mt-1 h-40 border rounded-md"></div>
                    </div>
                </form>
            </div>

            <!-- Modal footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 border-t border-gray-200">
                <button type="button"
                    class="close-modal px-4 py-2 rounded-md border border-gray-300 shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors text-sm font-medium">
                    Cancel
                </button>
                <button type="button" id="btn-save-book"
                    class="px-4 py-2 rounded-md border border-transparent shadow-sm bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors text-sm font-medium">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Preview thumbnail image when a file is selected
    document.getElementById('thumbnail')?.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('thumbnail-preview').src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });
</script>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">
                            Delete Book
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Are you sure you want to delete this book? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="btn-confirm-delete"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Delete
                </button>
                <button type="button"
                    class="close-delete-modal mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<style>
    /* Table styles */
    .table-row:hover {
        background-color: #f9fafb;
    }

    /* Status badges */
    .status-badge {
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-badge-Published {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-badge-Draft {
        background-color: #fef3c7;
        color: #d97706;
    }

    .status-badge-Archived {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    /* Custom checkbox */
    input[type="checkbox"] {
        border-radius: 0.25rem;
        border-color: #d1d5db;
    }

    input[type="checkbox"]:checked {
        background-color: #dc2626;
        border-color: #dc2626;
    }

    /* Button styles */
    .btn-primary {
        background-color: #dc2626;
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .btn-primary:hover {
        background-color: #b91c1c;
    }

    /* Status colors */
    .status-Published {
        border-top: 4px solid #10b981;
    }

    .status-Draft {
        border-top: 4px solid #f59e0b;
    }

    .status-Archived {
        border-top: 4px solid #6b7280;
    }
</style>
{% endblock %}

{% block script %}
<script>
    frappe.ready(function () {
        let products = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentBookId = null;

        // Initialize book loading when page is ready
        loadBooks();

        // Add event listener for Add Product button
        document.querySelector('button.flex.items-center.px-3.py-2.bg-red-600.text-white.rounded-md.text-sm').addEventListener('click', function () {
            openBookForm();
        });

        // Load books from server
        function loadBooks() {
            frappe.call({
                method: 'book_shop.book_shop.doctype.book.book.get_books',
                callback: function (r) {
                    if (r.message) {
                        products = r.message;
                        renderProductTable(products);
                    } else {
                        // Use sample data if server call fails
                        products = getSampleData();
                        renderProductTable(products);
                    }
                }
            });
        }

        // Sample data for testing
        function getSampleData() {
            const sampleProducts = [];

            for (let i = 1; i <= 10; i++) {
                sampleProducts.push({
                    name: `book_${i}`,
                    id: `30201${i}`,
                    book_name: 'The young Wizard',
                    category_id: 'Fiction',
                    stock: Math.floor(Math.random() * 20),
                    price: 121.00,
                    status: i % 3 === 0 ? 'Draft' : (i % 2 === 0 ? 'Published' : 'Low Stock'),
                    added: '29 Dec 2022'
                });
            }

            return sampleProducts;
        }

        // Render product table
        function renderProductTable(products) {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';

            // Calculate pagination indexes
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, products.length);
            const paginatedProducts = products.slice(startIndex, endIndex);

            paginatedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'table-row';

                // Format status badge
                let statusBadge = '';
                if (product.status === 'Low Stock') {
                    statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Low Stock</span>';
                } else if (product.status === 'Published') {
                    statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Published</span>';
                } else if (product.status === 'Draft') {
                    statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Draft</span>';
                } else {
                    statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">' + product.status + '</span>';
                }

                // Generate stock number if not present
                const stock = product.quantity || Math.floor(Math.random() * 20);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="h-4 w-4">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 flex-shrink-0">
                                <img class="h-10 w-10 rounded-full" src="${product.thumbnail || 'https://ui-avatars.com/api/?name=Book&background=random'}" alt="">
                            </div>
                            <div class="ml-4">
                                <div class="font-medium text-gray-900">${product.book_name}</div>
                                <div class="text-sm text-gray-500">3 variants</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-blue-600">${product.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${product.category_id || 'Uncategorized'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${product.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${product.added || '29 Dec 2022'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex space-x-2">
                            <a href="/edit_book?book_id=${product.name}" class="text-gray-500 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </a>
                            <a href="/delete_book?book_id=${product.name}" class="text-gray-500 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const bookId = this.getAttribute('data-id');
                    openBookForm(bookId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const bookId = this.getAttribute('data-id');
                    currentBookId = bookId;
                    document.getElementById('delete-modal').classList.remove('hidden');
                });
            });
        }

        // Open book form for editing
        function openBookForm(bookId = null) {
            const titleElement = document.getElementById('form-modal-title');
            const saveButton = document.getElementById('btn-save-book');

            // Reset form
            document.getElementById('book-form').reset();

            if (bookId) {
                // Edit mode
                titleElement.textContent = 'Edit Book';
                saveButton.textContent = 'Update';
                document.getElementById('book_id').value = bookId;

                // Load book data
                frappe.call({
                    method: 'frappe.client.get',
                    args: {
                        doctype: 'Book',
                        name: bookId
                    },
                    callback: function (r) {
                        if (r.message) {
                            const book = r.message;

                            // Fill form fields
                            document.getElementById('id').value = book.id;
                            document.getElementById('book_name').value = book.book_name;
                            document.getElementById('price').value = book.price;
                            document.getElementById('status').value = book.status;
                            document.getElementById('thumbnail-preview').src = book.thumbnail || '/assets/book_shop/images/default-book.svg';

                            if (book.category_id) {
                                document.getElementById('category_id').value = book.category_id;
                            }

                            if (typeof Quill !== 'undefined' && window.descriptionEditor) {
                                window.descriptionEditor.root.innerHTML = book.description || '';
                            }
                        }
                    }
                });
            } else {
                // Add mode
                titleElement.textContent = 'Add New Book';
                saveButton.textContent = 'Save';
                document.getElementById('book_id').value = '';
            }

            // Show modal
            document.getElementById('book-form-modal').classList.remove('hidden');
        }

        // Save book
        function saveBook() {
            const bookId = document.getElementById('book_id').value;
            const bookData = {
                doctype: 'Book',
                id: document.getElementById('id').value,
                book_name: document.getElementById('book_name').value,
                price: parseFloat(document.getElementById('price').value || 0),
                status: document.getElementById('status').value,
                quantity: parseInt(document.getElementById('quantity').value || 0)
            };

            if (document.getElementById('category_id').value) {
                bookData.category_id = document.getElementById('category_id').value;
            }

            if (typeof Quill !== 'undefined' && window.descriptionEditor) {
                bookData.description = window.descriptionEditor.root.innerHTML;
            }

            // Kiểm tra xem có file thumbnail được chọn không
            const thumbnailInput = document.getElementById('thumbnail');
            if (thumbnailInput.files && thumbnailInput.files.length > 0) {
                // Hiển thị thông báo đang tải
                frappe.show_alert({
                    message: 'Uploading image...',
                    indicator: 'blue'
                });

                // Sử dụng FileReader để chuyển đổi hình ảnh sang định dạng base64
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Thêm dữ liệu hình ảnh base64 vào bookData
                    bookData.thumbnail = e.target.result;

                    // Gọi hàm lưu sách với dữ liệu thumbnail
                    saveBookToServer(bookId, bookData);
                };
                reader.onerror = function (e) {
                    frappe.show_alert({
                        message: 'Error reading image file',
                        indicator: 'red'
                    });

                    // Vẫn lưu sách nhưng không có thumbnail
                    saveBookToServer(bookId, bookData);
                };
                // Bắt đầu đọc file dưới dạng URL dữ liệu (base64)
                reader.readAsDataURL(thumbnailInput.files[0]);
            } else {
                // Không có file mới được chọn, chỉ cập nhật dữ liệu sách
                saveBookToServer(bookId, bookData);
            }
        }

        // Hàm lưu sách lên máy chủ
        function saveBookToServer(bookId, bookData) {
            if (bookId) {
                // Cập nhật sách đã tồn tại
                frappe.call({
                    method: 'book_shop.book_shop.doctype.book.book.save_book',
                    args: {
                        book_data: JSON.stringify(bookData)
                    },
                    callback: function (r) {
                        if (r.message && r.message.success) {
                            // Ẩn modal
                            document.getElementById('book-form-modal').classList.add('hidden');

                            // Tải lại danh sách sách
                            loadBooks();

                            frappe.show_alert({
                                message: 'Book updated successfully',
                                indicator: 'green'
                            });
                        } else {
                            frappe.show_alert({
                                message: 'Error updating book: ' + (r.message?.message || 'Unknown error'),
                                indicator: 'red'
                            });
                        }
                    }
                });
            } else {
                // Tạo sách mới
                frappe.call({
                    method: 'book_shop.book_shop.doctype.book.book.save_book',
                    args: {
                        book_data: JSON.stringify(bookData)
                    },
                    callback: function (r) {
                        if (r.message && r.message.success) {
                            // Ẩn modal
                            document.getElementById('book-form-modal').classList.add('hidden');

                            // Tải lại danh sách sách
                            loadBooks();

                            frappe.show_alert({
                                message: 'Book added successfully',
                                indicator: 'green'
                            });
                        } else {
                            frappe.show_alert({
                                message: 'Error adding book: ' + (r.message?.message || 'Unknown error'),
                                indicator: 'red'
                            });
                        }
                    }
                });
            }
        }

        // Delete book
        function deleteBook() {
            if (currentBookId) {
                frappe.call({
                    method: 'frappe.client.delete',
                    args: {
                        doctype: 'Book',
                        name: currentBookId
                    },
                    callback: function (r) {
                        if (!r.exc) {
                            // Hide modal
                            document.getElementById('delete-modal').classList.add('hidden');

                            // Reload books
                            loadBooks();

                            frappe.show_alert({
                                message: 'Book deleted successfully',
                                indicator: 'green'
                            });
                        }
                    }
                });
            }
        }

        // Load categories
        function loadCategories() {
            frappe.call({
                method: 'frappe.client.get_list',
                args: {
                    doctype: 'Category',
                    fields: ['name', 'category_name'],
                    limit_page_length: 500
                },
                callback: function (r) {
                    if (r.message) {
                        const categorySelect = document.getElementById('category_id');
                        categorySelect.innerHTML = '<option value="">Select Category</option>';

                        r.message.forEach(function (category) {
                            const option = document.createElement('option');
                            option.value = category.name;
                            option.textContent = category.category_name || category.name;
                            categorySelect.appendChild(option);
                        });
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('btn-save-book').addEventListener('click', saveBook);
        document.getElementById('btn-confirm-delete').addEventListener('click', deleteBook);

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function () {
                document.getElementById('book-form-modal').classList.add('hidden');
            });
        });

        document.querySelectorAll('.close-delete-modal').forEach(btn => {
            btn.addEventListener('click', function () {
                document.getElementById('delete-modal').classList.add('hidden');
            });
        });

        // Initialize Quill editor if available
        if (typeof Quill !== 'undefined') {
            window.descriptionEditor = new Quill('#description-editor', {
                theme: 'snow',
                placeholder: 'Enter book description...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link'],
                        ['clean']
                    ]
                }
            });
        }

        // Initialize page
        loadBooks();
        loadCategories();
    });
</script>
{% endblock %}

{% block head_include %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<style>
    /* Ensure the full-height layout works properly */
    html,
    body {
        height: 100%;
        margin: 0;
    }

    #page-content {
        height: 100%;
    }

    .h-screen {
        height: 100vh;
    }
</style>
{% endblock %}