{% load static %}
{% include 'app/navbar.html' %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="{% static 'app/css/ShoppingCart.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/ordercomponent.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/navbar.css' %}">

    <script src="{% static 'app/js/ordercomponent.js' %}"></script>
    <script src="{% static 'app/js/ShoppingCart.js' %}"></script>
    <script src="{% static 'app/js/cart.js' %}"></script>
    <script src="{% static 'app/js/myscript.js' %}"></script>
    
</head>
<body>
<main>
    <div class="title">YOUR CART</div>
    <div class="hero">
        <div class="list-items">
            <div class="heading item" style="color: var(--color1);">
                <div class="tmp">
                    <input type="checkbox" name="" id="select-all">
                </div>
                <div class="book-cart-details">BOOK DETAILS</div>
                <div class="book-price">PRICE</div>
                <div class="book-amount">AMOUNT</div>
                <div class="total">TOTAL</div>
                <button class="tmp1">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>

            {% for item in items %}
            <div class="item">
                <div class="tmp">
                    <input type="checkbox" name="product_checkbox" value="{{ item.product.id }}">
                </div>
                <div class="book-cart-details">
                    <div class="book-img"><img src="{{item.product.ImageURL}}" alt=""></div>
                    <div class="details">
                        <div class="book-name">{{item.product.name|truncatewords:7}}</div>
                        <div class="book-author">{{item.product.author}}</div>
                        <div class="book-categories">Category: {% for category in item.product.category.all %}{{ category.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                    </div>
                </div>
                <div class="book-price">{{item.product.price}} $</div>
                <div class="book-amount">
                    <div class="amount-details">
                        <button class="update-cart minus" data-product={{item.product.id}} data-action="remove">-</button>
                        <div class="amount">{{ item.quantity }}</div>
                        <button class="update-cart add" data-product={{item.product.id}} data-action="add">+</button>
                    </div>
                </div>
                <div class="total">{{ item.total_price }} $</div>
                <button class="tmp1">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
            {% endfor %}
        </div>

        <div class="details">
            <div class="details-title">ORDER SUMMARY</div>
            <div class="list-item">
                <div class="total-item">
                    <div class="heading">
                        <div class="Total">Total Items:</div>
                        <div class="Total-num" id="totalItems">0</div>
                    </div>
                    <div id="selectedItems">
                        <!-- Selected items will be dynamically added here -->
                    </div>
                </div>
                <div class="total-cost">
                    <div class="tag">Total Cost:</div>
                    <div class="cost" id="totalCost">0 $</div>
                </div>
                <div class="buy-btn"><button>CHECK OUT</button></div>
            </div>
        </div>
    </div>
</main>

<!-- Popup đặt hàng -->
<div class="popup" id="checkout-popup" style="display:none;">
    <form class="order-form" id="checkout-form">
        {% csrf_token %}
        <div class="heading">ORDER</div>
        <div class="Information">
            <div class="subheading">Information</div>

            <input type="hidden" name="id" value="{{ user.id }}">
            <input type="hidden" name="email" value="{{ user.email }}">

            <div class="user-info">
                <input type="text" id="receiver-name" name="name" placeholder="Receiver's Name" required>
                <input type="text" id="receiver-phone" name="mobile" placeholder="Phone" required>
                <input type="text" id="receiver-address" name="address" placeholder="Address" required>
                <input type="text" id="receiver-city" name="city" placeholder="City">
                <input type="text" id="receiver-pin" name="pincode" placeholder="Pin">
            </div>
        </div>

        <div class="subheading">Your orders:</div>
        <div class="list-items"></div>
        <div class="payments">
            <label for="payment">Payment Method:</label>
            <select name="payment" required>
                <option value="COD">Cash On Delivery</option>
            </select>
            <div class="total">Total: {{ order.get_cart_total }} $</div>
        </div>

        <div class="submit">
            <button id="cancel-btn" type="button">Cancel</button>
            <button type="submit">Submit</button>
        </div>
    </form>
</div>




</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        fillShippingAddress(); // Tự động điền khi tải trang

        const checkoutPopup = document.getElementById("checkout-popup");
        const cancelBtn = document.getElementById("cancel-btn");
        const checkoutForm = document.getElementById("checkout-form");
        
        // Hiện popup checkout
        document.querySelector(".buy-btn button").onclick = () => {
            // Check if any items are selected
            const selectedItems = document.querySelectorAll('input[name="product_checkbox"]:checked');
            if (selectedItems.length === 0) {
                alert("Please select at least one item to checkout!");
                return;
            }
            checkoutPopup.style.display = "block";
        };
    
        // Ẩn popup khi cancel
        cancelBtn.onclick = () => {
            checkoutPopup.style.display = "none";
        };
    
        // Single form submission handler
        checkoutForm.addEventListener("submit", function(event) {
            event.preventDefault();
            
            // Validate form
            const requiredFields = ['name', 'mobile', 'address'];
            for (let field of requiredFields) {
                const input = document.querySelector(`input[name="${field}"]`);
                if (!input.value.trim()) {
                    alert(`Please fill in ${field}`);
                    return;
                }
            }

            // Get selected items
            const selectedProducts = [];
            document.querySelectorAll('input[name="product_checkbox"]:checked').forEach(checkbox => {
                const item = checkbox.closest('.item');
                const productId = checkbox.value;
                const quantity = parseInt(item.querySelector('.amount').textContent);
                selectedProducts.push({
                    productId: productId,
                    quantity: quantity
                });
            });

            if (selectedProducts.length === 0) {
                alert("Please select at least one product!");
                return;
            }

            const formData = new FormData(checkoutForm);
            // Add selected products to form data
            formData.append('products', JSON.stringify(selectedProducts));

            fetch("{% url 'checkout' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken()
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert("Order placed successfully!");
                    window.location.href = "{% url 'order_success' %}";
                } else {
                    alert("Error placing order: " + (data.message || "Unknown error"));
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred during checkout!");
            });
        });
    });
    
    function fillShippingAddress() {
        // Lấy dữ liệu từ API hoặc từ LocalStorage (tạm thời giả lập bằng object)
        let shippingData = {
            name: "{{ request.user.username }}",
            mobile: "{{ shipping.mobile }}",
            address: "{{ shipping.address }}",
            city: "{{ shipping.city }}",
            pincode: "{{ shipping.pincode }}"
        };
    
        // Cập nhật giá trị vào các ô input
        document.getElementById("receiver-name").value = shippingData.name || "";
        document.getElementById("receiver-phone").value = shippingData.mobile || "";
        document.getElementById("receiver-address").value = shippingData.address || "";
        document.getElementById("receiver-city").value = shippingData.city || "";
        document.getElementById("receiver-pin").value = shippingData.pincode || "";
    }

    function getCSRFToken() {
        return document.querySelector("[name=csrfmiddlewaretoken]").value;
    }
</script> 
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Select all functionality
        const selectAllCheckbox = document.getElementById('select-all');
        const productCheckboxes = document.getElementsByName('product_checkbox');

        selectAllCheckbox.addEventListener('change', function() {
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateOrderSummary();
        });

        // Individual checkbox change
        productCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateOrderSummary);
        });

        // Update amounts
        const minusButtons = document.querySelectorAll('.minus');
        const addButtons = document.querySelectorAll('.add');

        minusButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                setTimeout(updateOrderSummary, 100);
            });
        });

        addButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                setTimeout(updateOrderSummary, 100);
            });
        });

        function updateOrderSummary() {
            let totalItems = 0;
            let totalCost = 0;
            const selectedItems = [];

            productCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const item = checkbox.closest('.item');
                    const quantity = parseInt(item.querySelector('.amount').textContent);
                    const price = parseFloat(item.querySelector('.book-price').textContent.replace(/[^\d.-]/g, ''));
                    const name = item.querySelector('.book-name').textContent;

                    totalItems += quantity;
                    totalCost += quantity * price;
                    selectedItems.push({ name, quantity });
                }
            });

            // Update summary display
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalCost').textContent = totalCost.toLocaleString('vi-VN') + ' $';

            // Update selected items list
            const selectedItemsContainer = document.getElementById('selectedItems');
            selectedItemsContainer.innerHTML = '';
            selectedItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item');
                itemDiv.innerHTML = `
                    <div class="book-name">${item.name}</div>
                    <div class="book-amount">x${item.quantity}</div>
                `;
                selectedItemsContainer.appendChild(itemDiv);
            });
        }

        // Initial update
        updateOrderSummary();
    });
</script>

</html>