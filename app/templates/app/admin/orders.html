{% extends 'app/admin/base.html' %}

{% block title %}Order Management{% endblock %}
{% block page_title %}Order Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">Orders List</h6>
        <!-- Add status filter -->
        <div class="mt-3">
            <form method="GET" class="form-inline">
                <select name="status" class="form-control mr-2" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    {% for status_code, status_name in status_choices %}
                    <option value="{{ status_code }}" {% if current_status == status_code %}selected{% endif %}>
                        {{ status_name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered datatable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.customer.username }}</td>
                        <td>{{ order.date_ordered|date:"d M Y H:i" }}</td>
                        <td>{{ order.get_cart_items }}</td>
                        <td>${{ order.get_cart_total|floatformat:2 }}</td>
                        <td>
                            {% if order.status == 'pending' %}
                                <span class="badge bg-warning">Chờ xác nhận</span>
                            {% elif order.status == 'confirmed' %}
                                <span class="badge bg-info">Đã xác nhận</span>
                            {% elif order.status == 'shipping' %}
                                <span class="badge bg-primary">Đang giao</span>
                            {% elif order.status == 'completed' %}
                                <span class="badge bg-success">Hoàn thành</span>
                            {% elif order.status == 'cancelled' %}
                                <span class="badge bg-danger">Đã hủy</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#viewOrderModal{{ order.id }}">
                                <i class="ri-eye-line"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% for order in orders %}
<!-- View Order Modal -->
<div class="modal fade" id="viewOrderModal{{ order.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details #{{ order.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6>Order Status</h6>                    <form method="POST" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_status">
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <select name="status" class="form-control form-control-sm d-inline-block w-auto" onchange="this.form.submit()">
                            {% for status_code, status_name in status_choices %}
                            <option value="{{ status_code }}" {% if order.status == status_code %}selected{% endif %}>
                                {{ status_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>

                <h6>Order Items</h6>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.orderitem_set.all %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>${{ item.product.price|floatformat:2 }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>${{ item.get_total|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td><strong>${{ order.get_cart_total|floatformat:2 }}</strong></td>
                        </tr>
                    </tfoot>
                </table>

                {% if order.shippingaddress_set.first %}
                {% with shipping=order.shippingaddress_set.first %}
                <h6>Shipping Information</h6>
                <p>
                    Address: {{ shipping.address }}<br>
                    City: {{ shipping.city }}<br>
                    State: {{ shipping.state }}<br>
                    Phone: {{ shipping.mobile }}
                </p>
                {% endwith %}
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_scripts %}
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}